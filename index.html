<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>교육연구사 이정도의 웹앱 허브</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap');
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #f3f4f6;
        }
        .app-card-wrapper {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .app-card-wrapper.draggable {
            cursor: grab;
        }
        .app-card-wrapper.draggable:active {
            cursor: grabbing;
        }
        .app-card-wrapper.dragging {
            opacity: 0.5;
            border: 2px dashed #3b82f6;
            transform: scale(0.95);
        }
        .app-card-inner:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .over {
            transform: scale(1.02);
            border: 2px dashed #9ca3af;
        }
        body:not(.admin-mode) .admin-only {
            display: none !important;
        }
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* 오프라인 모드 표시 */
        .offline-badge {
            background-color: #fbbf24;
            color: #92400e;
            padding: 2px 8px;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
    </style>
</head>
<body class="text-gray-800 flex flex-col min-h-screen relative">

    <!-- 헤더 영역 -->
    <header class="bg-white shadow-sm sticky top-0 z-40 border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-blue-600 rounded-full flex items-center justify-center text-white font-bold text-lg">
                    이
                </div>
                <div>
                    <h1 class="text-xl font-bold text-gray-900 leading-tight">교육연구사 이정도</h1>
                    <p class="text-xs text-gray-500">교육용 웹앱 통합 관리</p>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <!-- 상태 표시 메시지 -->
                <div id="status-msg" class="text-xs text-gray-500 hidden sm:block"></div>
                
                <!-- 관리자 로그인 버튼 -->
                <button id="login-btn" onclick="toggleAdminMode()" class="text-gray-400 hover:text-blue-600 transition-colors p-2 flex items-center gap-1" title="관리자 모드 전환">
                    <i class="fas fa-lock" id="lock-icon"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- 메인 컨텐츠 -->
    <main class="flex-grow max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10 w-full z-0">
        
        <!-- 환영 메시지 -->
        <div class="mb-10 text-center">
            <h2 class="text-3xl font-bold text-gray-800 mb-3">웹앱 바로가기</h2>
            <p class="text-gray-600 max-w-2xl mx-auto">
                필요한 교육 도구를 선택하세요.<br>
                <span class="text-sm text-blue-600 admin-only"><i class="fas fa-info-circle"></i> 관리자 모드: 드래그하여 순서를 바꾸거나 편집할 수 있습니다.</span>
            </p>
            <!-- 오프라인 모드 안내 (숨김 처리됨) -->
            <div id="offline-notice" class="hidden mt-2">
                <span class="offline-badge">
                    <i class="fas fa-wifi-slash"></i> 오프라인 모드 (내 컴퓨터에만 저장됨)
                </span>
            </div>
        </div>

        <!-- 로딩 인디케이터 -->
        <div id="loading" class="flex justify-center my-10">
            <div class="loader"></div>
        </div>

        <!-- 카드 그리드 -->
        <div id="app-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 opacity-0 transition-opacity duration-300">
            <!-- 카드가 여기에 동적으로 추가됩니다 -->
        </div>

    </main>

    <!-- 푸터 -->
    <footer class="bg-gray-800 text-gray-300 py-8 mt-auto">
        <div class="max-w-7xl mx-auto px-4 text-center">
            <p class="mb-2">© 2026 교육연구사 이정도. All rights reserved.</p>
            <p class="text-sm text-gray-500">문의: prindodo@fe.jne.kr</p>
        </div>
    </footer>

    <!-- 수정 모달 (팝업) -->
    <div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md mx-4 transform transition-all">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800">웹앱 정보 수정</h3>
                <button onclick="window.closeEditModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <input type="hidden" id="editIndex">
            
            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2" for="editTitle">제목</label>
                <input type="text" id="editTitle" class="shadow-sm appearance-none border border-gray-300 rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            </div>
            
            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2" for="editDesc">설명</label>
                <textarea id="editDesc" class="shadow-sm appearance-none border border-gray-300 rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" rows="3"></textarea>
            </div>
            
            <div class="mb-6">
                <label class="block text-gray-700 text-sm font-bold mb-2" for="editUrl">URL (링크 주소)</label>
                <input type="url" id="editUrl" class="shadow-sm appearance-none border border-gray-300 rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="https://...">
            </div>
            
            <div class="flex justify-end gap-2">
                <button onclick="window.closeEditModal()" class="bg-gray-100 hover:bg-gray-200 text-gray-800 font-medium py-2 px-4 rounded transition-colors focus:outline-none">
                    취소
                </button>
                <button onclick="window.saveEdit()" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded shadow transition-colors focus:outline-none">
                    저장하기
                </button>
            </div>
        </div>
    </div>

    <!-- 파이어베이스 SDK (모듈 방식) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, initializeFirestore } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
        
        // 파이어베이스 설정 (수정하지 마세요)
        const firebaseConfig = {
            apiKey: "AIzaSyBMQ3mK_KoafU1L53LLwD4BsotItVD46zo",
            authDomain: "web-hub-dcbc0.firebaseapp.com",
            projectId: "web-hub-dcbc0",
            storageBucket: "web-hub-dcbc0.firebasestorage.app",
            messagingSenderId: "1051708659248",
            appId: "1:1051708659248:web:1428871a9d902f39d47ff5",
            measurementId: "G-Q3GQGGEH1B"
        };

        // 전역 변수
        let db;
        let auth;
        let isOfflineMode = false; // 오프라인 모드 상태 플래그
        let apps = [];
        let isAdmin = false;
        let dragStartIndex;
        const LOCAL_STORAGE_KEY = 'teacherLee_apps_backup'; // 로컬 저장소 키

        // Firebase 초기화 시도
        try {
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            // 롱폴링 강제 설정
            db = initializeFirestore(app, {
                experimentalForceLongPolling: true, 
            });
        } catch (e) {
            console.error("Firebase Init Failed:", e);
            enableOfflineMode("초기화 오류");
        }

        // 초기 데이터 (기본값)
        const initialApps = [
            {
                title: "학급 경영 도우미",
                description: "학생들의 출결, 상담 일지를 기록하고 관리하는 웹앱입니다.",
                url: "https://www.google.com", 
                icon: "fa-users",
                color: "bg-blue-500"
            },
            {
                title: "성적 분석 계산기",
                description: "시험 점수를 입력하면 성취도와 등급을 자동으로 산출합니다.",
                url: "https://www.google.com", 
                icon: "fa-calculator",
                color: "bg-green-500"
            }
        ];

        // 앱 시작
        async function initApp() {
            // 오프라인 모드면 바로 로컬 로드
            if (isOfflineMode) {
                loadAppsOffline();
                return;
            }

            try {
                // 로그인 시도
                await signInAnonymously(auth);
                console.log("Cloud: 로그인 성공");
                await loadApps();
            } catch (error) {
                console.warn("Cloud 연결 실패, 오프라인 모드로 전환:", error.message);
                enableOfflineMode("네트워크 연결 불가");
                loadAppsOffline(); // 즉시 로컬 데이터 로드
            }
        }

        // [기능 1] 오프라인 모드 활성화
        function enableOfflineMode(reason) {
            isOfflineMode = true;
            document.getElementById('offline-notice').classList.remove('hidden');
            document.getElementById('status-msg').innerHTML = `<span class='text-amber-600'>⚠️ ${reason} (자동 저장)</span>`;
            console.log("오프라인 모드 활성화됨:", reason);
        }

        // [기능 2] 로컬 저장소에서 불러오기 (백업본)
        function loadAppsOffline() {
            const saved = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (saved) {
                try {
                    apps = JSON.parse(saved);
                    console.log("Local: 데이터 로드 성공");
                } catch(e) {
                    apps = [...initialApps];
                }
            } else {
                apps = [...initialApps];
            }
            renderApps();
        }

        // [기능 3] DB에서 불러오기
        async function loadApps() {
            try {
                const docRef = doc(db, "settings", "main");
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    apps = docSnap.data().appList || [];
                    // 성공 시 로컬에도 백업 저장
                    localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(apps));
                } else {
                    apps = [...initialApps];
                }
                renderApps();
            } catch (error) {
                // 불러오기 실패 시 오프라인 모드로 전환
                console.error("Cloud 로드 실패:", error);
                enableOfflineMode("데이터 로드 실패");
                loadAppsOffline();
            }
        }

        // [기능 4] 데이터 저장 (하이브리드 방식)
        async function saveApps() {
            // 1. 무조건 로컬에 먼저 저장 (가장 중요)
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(apps));

            // 2. 오프라인 모드면 여기서 끝
            if (isOfflineMode) {
                showSaveStatus("내 컴퓨터에만 저장됨 (오프라인)");
                return;
            }

            // 3. 온라인이면 클라우드 시도
            if (!auth.currentUser) {
                 // 로그인 풀렸으면 재시도
                 try { await signInAnonymously(auth); } catch(e) { 
                     enableOfflineMode("인증 만료"); 
                     showSaveStatus("내 컴퓨터에만 저장됨");
                     return; 
                }
            }

            try {
                document.getElementById('status-msg').innerText = "클라우드 저장 중...";
                const docRef = doc(db, "settings", "main");
                await setDoc(docRef, { appList: apps });
                showSaveStatus("모든 기기에 저장 완료");
            } catch (error) {
                console.error("Cloud 저장 실패:", error);
                // 실패 시 오프라인 모드로 전환하고 사용자 안심시키기
                enableOfflineMode("클라우드 오류");
                showSaveStatus("내 컴퓨터에 저장됨 (클라우드 실패)");
            }
        }

        function showSaveStatus(msg) {
            const el = document.getElementById('status-msg');
            el.innerText = msg;
            setTimeout(() => { 
                if(!isOfflineMode) el.innerText = ""; 
            }, 3000);
        }

        // 렌더링 함수
        function renderApps() {
            const grid = document.getElementById('app-grid');
            const loading = document.getElementById('loading');
            
            loading.style.display = 'none';
            grid.classList.remove('opacity-0');

            grid.innerHTML = apps.map((app, index) => `
                <div class="app-card-wrapper relative group h-full ${isAdmin ? 'draggable' : ''}" 
                     ${isAdmin ? 'draggable="true"' : ''} 
                     data-index="${index}">
                    
                    <div class="absolute -top-3 -right-2 z-20 flex gap-1 admin-only opacity-0 group-hover:opacity-100 transition-all duration-200">
                        <button onclick="window.openEditModal(${index})" 
                                class="w-8 h-8 bg-white border border-gray-200 rounded-full text-gray-500 hover:text-blue-600 hover:bg-blue-50 shadow-md flex items-center justify-center transition-colors">
                            <i class="fas fa-pen text-xs"></i>
                        </button>
                        <button onclick="window.deleteApp(${index})" 
                                class="w-8 h-8 bg-white border border-gray-200 rounded-full text-gray-500 hover:text-red-500 hover:bg-red-50 shadow-md flex items-center justify-center transition-colors">
                            <i class="fas fa-trash-alt text-xs"></i>
                        </button>
                    </div>
                    
                    <a href="${app.url}" target="_blank" class="app-card-inner block bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden hover:border-blue-300 h-full transition-all duration-300">
                        <div class="p-6">
                            <div class="flex items-center justify-between mb-4">
                                <div class="w-12 h-12 ${app.color} rounded-lg flex items-center justify-center text-white text-xl shadow-md group-hover:scale-110 transition-transform duration-300">
                                    <i class="fas ${app.icon}"></i>
                                </div>
                                <div class="flex flex-col items-end">
                                    <i class="fas fa-grip-lines text-gray-200 group-hover:text-gray-400 mb-1 admin-only cursor-grab"></i>
                                    <span class="text-gray-300 group-hover:text-blue-500 transition-colors text-xs">
                                        <i class="fas fa-external-link-alt"></i>
                                    </span>
                                </div>
                            </div>
                            <h3 class="text-xl font-bold text-gray-800 mb-2 group-hover:text-blue-600 transition-colors">${app.title}</h3>
                            <p class="text-gray-500 text-sm leading-relaxed mb-4 h-10 overflow-hidden text-ellipsis line-clamp-2">
                                ${app.description}
                            </p>
                            <div class="flex items-center text-sm font-medium text-blue-600 opacity-0 group-hover:opacity-100 transition-opacity transform translate-y-2 group-hover:translate-y-0">
                                이동하기 <i class="fas fa-arrow-right ml-2"></i>
                            </div>
                        </div>
                    </a>
                </div>
            `).join('');

            if (isAdmin) {
                addDragEvents();
            }
        }

        // =================================================================
        // UI 이벤트 핸들러
        // =================================================================
        
        window.toggleAdminMode = function() {
            if (!isAdmin) {
                const password = prompt("관리자 비밀번호를 입력하세요 (초기 비밀번호: 1234)");
                if (password === "1234") { 
                    isAdmin = true;
                    document.body.classList.add('admin-mode');
                    document.getElementById('lock-icon').className = "fas fa-lock-open text-blue-600";
                    renderApps(); 
                    alert("관리자 모드가 활성화되었습니다.");
                } else if (password !== null) {
                    alert("비밀번호가 틀렸습니다.");
                }
            } else {
                isAdmin = false;
                document.body.classList.remove('admin-mode');
                document.getElementById('lock-icon').className = "fas fa-lock";
                renderApps();
            }
        };

        window.deleteApp = function(index) {
            if(confirm('이 항목을 삭제하시겠습니까?')) {
                apps.splice(index, 1);
                renderApps();
                saveApps();
            }
        };

        const editModal = document.getElementById('editModal');
        
        window.openEditModal = function(index) {
            const app = apps[index];
            document.getElementById('editIndex').value = index;
            document.getElementById('editTitle').value = app.title;
            document.getElementById('editDesc').value = app.description;
            document.getElementById('editUrl').value = app.url;
            editModal.classList.remove('hidden');
        };

        window.closeEditModal = function() {
            editModal.classList.add('hidden');
        };

        window.saveEdit = function() {
            const index = document.getElementById('editIndex').value;
            const newTitle = document.getElementById('editTitle').value;
            const newDesc = document.getElementById('editDesc').value;
            const newUrl = document.getElementById('editUrl').value;

            if(!newTitle || !newUrl) {
                alert('제목과 URL은 필수입니다.');
                return;
            }

            apps[index] = { ...apps[index], title: newTitle, description: newDesc, url: newUrl };
            window.closeEditModal();
            renderApps();
            saveApps();
        };

        function addDragEvents() {
            const draggables = document.querySelectorAll('.app-card-wrapper.draggable');
            draggables.forEach(draggable => {
                draggable.addEventListener('dragstart', dragStart);
                draggable.addEventListener('dragover', dragOver);
                draggable.addEventListener('drop', dragDrop);
                draggable.addEventListener('dragenter', dragEnter);
                draggable.addEventListener('dragleave', dragLeave);
            });
        }

        function dragStart(e) {
            dragStartIndex = +this.getAttribute('data-index');
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }
        function dragOver(e) { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; }
        function dragEnter(e) { e.preventDefault(); this.classList.add('over'); }
        function dragLeave() { this.classList.remove('over'); }
        function dragDrop(e) {
            e.preventDefault();
            const dragEndIndex = +this.getAttribute('data-index');
            this.classList.remove('over');
            if (dragStartIndex !== dragEndIndex) {
                const itemToMove = apps[dragStartIndex];
                apps.splice(dragStartIndex, 1);
                apps.splice(dragEndIndex, 0, itemToMove);
                renderApps();
                saveApps(); 
            }
            document.querySelectorAll('.app-card-wrapper').forEach(item => item.classList.remove('dragging', 'over'));
        }

        // 앱 시작
        initApp();

    </script>
</body>
</html>
